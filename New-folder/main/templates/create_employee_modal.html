<!-- Modal tạo nhân viên mới với bố cục giống modal sửa, không có trường mã nhân viên -->
<div class="modal fade" id="createEmployeeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: center; align-items: center;">
                <h2>Tạo Nhân Viên Mới</h2>
            </div>
            <div class="modal-body">
                <form id="createEmployeeForm">
                    <div class="row-fluid">
                        <div class="span6">
                            <div class="control-group">
                                <label for="lastName">Họ:</label>
                                <div class="controls">
                                    <input type="text" id="lastName" name="lastName" class="form-control" required>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="firstName">Tên:</label>
                                <div class="controls">
                                    <input type="text" id="firstName" name="firstName" class="form-control" required>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="email">Email:</label>
                                <div class="controls">
                                    <input type="email" id="email" name="email" class="form-control" required>
                                    <small id="email-exists-msg" style="color: red; display: none;">Email đã tồn
                                        tại!</small>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="phoneNumber">Số điện thoại:</label>
                                <div class="controls">
                                    <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control"
                                        maxlength="10" required>
                                    <small id="phone-msg" style="color: red; display: none;">Số điện thoại phải là 10
                                        số!</small>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="city">Thành phố:</label>
                                <div class="controls">
                                    <input type="text" id="city" name="city" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="span6">
                            <div class="control-group">
                                <label for="ssn">SSN:</label>
                                <div class="controls">
                                    <input type="text" id="ssn" name="ssn" class="form-control" maxlength="5" required>
                                    <small id="ssn-msg" style="color: red; display: none;">SSN phải là 5 số!</small>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="payRate">Mức lương:</label>
                                <div class="controls">
                                    <input type="number" id="payRate" name="payRate" class="form-control" required>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="vacationDays">Số ngày nghỉ:</label>
                                <div class="controls">
                                    <input type="number" id="vacationDays" name="vacationDays" class="form-control"
                                        required>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="gender">Giới tính:</label>
                                <div class="controls">
                                    <select id="gender" name="gender" class="form-control" required>
                                        <option value="true">Nam</option>
                                        <option value="false">Nữ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="submitEmployee">Tạo nhân viên</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Kiểm tra email tồn tại khi blur khỏi input
        $('#email').on('blur', function () {
            var email = $(this).val();
            if (email) {
                $.get('/api/employee/check-email', { email: email }, function (res) {
                    if (res.exists) {
                        $('#email-exists-msg').show();
                        checkFormValidity();
                    } else {
                        $('#email-exists-msg').hide();
                        checkFormValidity();
                    }
                });
            } else {
                $('#email-exists-msg').hide();
                checkFormValidity();
            }
        });

        function checkFormValidity() {
            if ($('#phone-msg').is(':hidden') && $('#ssn-msg').is(':hidden') && $('#email-exists-msg').is(':hidden')) {
                $('#submitEmployee').prop('disabled', false);
            } else {
                $('#submitEmployee').prop('disabled', true);
            }
        }

        // Validation số điện thoại
        $(document).on('input', '#phoneNumber', function () {
            var val = $(this).val();
            var isValid = /^\d{10}$/.test(val);
            if (!isValid && val.length > 0) {
                $('#phone-msg').show();
            } else {
                $('#phone-msg').hide();
            }
            checkFormValidity();
        });

        // Validation SSN
        $(document).on('input', '#ssn', function () {
            var val = $(this).val();
            var isValid = /^\d{5}$/.test(val);
            if (!isValid && val.length > 0) {
                $('#ssn-msg').show();
            } else {
                $('#ssn-msg').hide();
            }
            checkFormValidity();
        });

        // Xử lý sự kiện click nút tạo nhân viên
        $('#submitEmployee').click(function () {
            const formData = {};
            $('#createEmployeeForm').serializeArray().forEach(item => {
                formData[item.name] = item.value;
            });
            $.ajax({
                url: '/api/employee/create',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success) {
                        alert('Đã gửi yêu cầu tạo nhân viên thành công!');
                        $('#createEmployeeModal').modal('hide');
                        $('#createEmployeeForm')[0].reset();
                        if ($('#yourTableId').length) {
                            $('#yourTableId').DataTable().ajax.reload();
                        }
                        socket.on('data_updated', function (data) {
                            // Cập nhật lại bảng ở đây
                        });
                    } else {
                        alert('Tạo nhân viên thất bại!');
                    }
                },
                error: function (xhr, status, error) {
                    alert('Có lỗi xảy ra khi tạo nhân viên: ' + error);
                }
            });
        });

        // Xử lý sự kiện khi modal được mở
        $('#createEmployeeModal').on('shown.bs.modal', function () {
            $('#createEmployeeForm')[0].reset();
            $('#lastName').focus();
            $('#email-exists-msg').hide();
            $('#phone-msg').hide();
            $('#ssn-msg').hide();
            $('#submitEmployee').prop('disabled', false);
        });

        // Đảm bảo chỉ 1 modal được mở
        $('.modal').modal('hide');

        //$(document).on('input', '#phoneNumber', function () { alert('ok'); });
    });
</script>

<style>
    #createEmployeeModal .modal-body {
        opacity: 1 !important;
        background: #fff !important;
        pointer-events: auto !important;
    }

    #createEmployeeModal .modal-content {
        opacity: 1 !important;
        pointer-events: auto !important;
    }
</style>